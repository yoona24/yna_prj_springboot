name: Deploy YA-PRJ to EC2


on:
 push:
   branches: [main, master]
 workflow_dispatch:


env:
 EC2_HOST: 3.107.106.95
 EC2_USER: ubuntu
 DEPLOY_PATH: /home/ubuntu/yna_prj_springboot


jobs:
 deploy:
   name: Deploy to EC2
   runs-on: ubuntu-latest
  
   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     # SSH í‚¤ ì„¤ì •
     - name: Configure SSH
       run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts


     # EC2ì— ë°°í¬
     - name: Deploy to EC2
       run: |
         ssh -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'ENDSSH'
          echo "ğŸš€ Starting deployment..."
         
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /home/ubuntu/ya_prj
         
          # Git ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
          git fetch origin
          git reset --hard origin/main || git reset --hard origin/master
         
          # í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
          cd app
          cat > .env << EOF
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          EOF
         
          # Docker Composeë¡œ ì¬ë°°í¬
          docker-compose down --remove-orphans 2>/dev/null || true
          docker-compose up -d --build
         
          # ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸
          echo "ğŸ“¦ Container Status:"
          docker-compose ps
         
          echo "âœ… Deployment completed!"
          ENDSSH


     # í—¬ìŠ¤ ì²´í¬
     - name: Health Check
       run: |
        echo "â³ Waiting for services..."
        sleep 20
       
        echo "ğŸ” Checking backend..."
        curl -sf http://${{ env.EC2_HOST }}:8000/api/v1/health && echo "âœ… Backend OK" || echo "âš ï¸ Backend check failed"
       
        echo "ğŸ” Checking frontend..."
        curl -sf http://${{ env.EC2_HOST }}:9000 && echo "âœ… Frontend OK" || echo "âš ï¸ Frontend check failed"
