name: Build and Deploy YA-PRJ


on:
 push:
   branches: [main, master]
 pull_request:
   branches: [main, master]
   types: [closed]
 workflow_dispatch:


env:
 EC2_HOST: 3.107.106.95
 EC2_USER: ubuntu
 DEPLOY_PATH: /home/ubuntu/yna_prj_springboot


jobs:
 # ========================================
 # ÎπåÎìú Î∞è ÌÖåÏä§Ìä∏ Job
 # ========================================
 build:
   name: Build & Test
   runs-on: ubuntu-latest

   strategy:
      matrix:
        node-version: [20.x]
  
   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     # Frontend ÎπåÎìú
     - name: Setup Node.js
       uses: actions/setup-node@v4
       with:
         node-version: ${{ matrix.node-version }}
         cache: 'npm'
         cache-dependency-path: app/frontend/package-lock.json


     - name: Install frontend dependencies
       working-directory: app/frontend
       run: npm ci


     - name: Lint frontend
       working-directory: app/frontend
       run: npm run lint --if-present
       continue-on-error: true


     - name: Build frontend
       working-directory: app/frontend
       env:
         VITE_API_URL: http://${{ secrets.HOST }}:8000
       run: npm run build


     # Backend ÎπåÎìú
     - name: Setup Java
       uses: actions/setup-java@v4
       with:
         java-version: '17'
         distribution: 'temurin'
         cache: 'gradle'


     - name: Grant execute permission for gradlew
       working-directory: app/backend-spring
       run: chmod +x gradlew


     - name: Build backend
       working-directory: app/backend-spring
       run: ./gradlew build -x test --no-daemon


     - name: Run backend tests
       working-directory: app/backend-spring
       run: ./gradlew test --no-daemon
       continue-on-error: true


     # ÎπåÎìú ÏïÑÌã∞Ìå©Ìä∏ ÏóÖÎ°úÎìú
     - name: Upload frontend build
       uses: actions/upload-artifact@v4
       with:
         name: frontend-dist
         path: app/frontend/dist
         retention-days: 1


     - name: Upload backend build
       uses: actions/upload-artifact@v4
       with:
         name: backend-jar
         path: app/backend-spring/build/libs/*.jar
         retention-days: 1


 # ========================================
 # Î∞∞Ìè¨ Job
 # ========================================
 deploy:
   name: Deploy to EC2
   runs-on: ubuntu-latest
   needs: build
   if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true) || github.event_name == 'workflow_dispatch'
  
   steps:
     - name: Checkout code
       uses: actions/checkout@v4


     - name: Download frontend build
       uses: actions/download-artifact@v4
       with:
         name: frontend-dist
         path: app/frontend/dist


     - name: Download backend build
       uses: actions/download-artifact@v4
       with:
         name: backend-jar
         path: app/backend-spring/build/libs


     # SSH ÏÑ§Ï†ï
     - name: Configure SSH
       run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts


     # ÌååÏùº ÎèôÍ∏∞Ìôî
     - name: Sync files to EC2
       run: |
         rsync -avz --delete \
          --exclude 'node_modules' \
          --exclude '.git' \
          --exclude '*.log' \
          --exclude '.gradle' \
          -e "ssh -o StrictHostKeyChecking=no" \
          ./app/ ${{ env.EC2_USER }}@${{ secrets.HOST }}:${{ env.DEPLOY_PATH }}/app/


     # Docker Compose Î∞∞Ìè¨
     - name: Deploy with Docker Compose
       run: |
          ssh -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.HOST }} << 'ENDSSH'
          echo "üöÄ Starting deployment..."
          cd /home/ubuntu/ya_prj/app
         
          # ÌôòÍ≤Ω Î≥ÄÏàò ÌååÏùº ÏÉùÏÑ±
          cat > .env << EOF
          KAKAO_CLIENT_ID=${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET=${{ secrets.KAKAO_CLIENT_SECRET }}
          NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
          GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
          EOF
         
          # Ïù¥Ï†Ñ Ïª®ÌÖåÏù¥ÎÑà Ï†ïÎ¶¨ Î∞è Ïû¨ÏãúÏûë
          docker-compose down --remove-orphans 2>/dev/null || true
          docker system prune -f 2>/dev/null || true
          docker-compose up -d --build
         
          # ÏÉÅÌÉú ÌôïÏù∏
          sleep 5
          docker-compose ps
         
          echo "‚úÖ Deployment completed!"
          ENDSSH


     # Ìó¨Ïä§ Ï≤¥ÌÅ¨
     - name: Health Check
       run: |
         echo "‚è≥ Waiting for services to start..."
         sleep 30
       
         echo "üîç Backend health check..."
         for i in {1..5}; do
          if curl -sf http://${{ secrets.HOST }}:8000/api/v1/health; then
            echo "‚úÖ Backend is healthy!"
            break
          fi
          echo "Retry $i..."
          sleep 5
         done
       
         echo "üîç Frontend health check..."
         curl -sf http://${{ secrets.HOST }}:9000 && echo "‚úÖ Frontend is healthy!" || echo "‚ö†Ô∏è Frontend check failed"


     # Î∞∞Ìè¨ ÏôÑÎ£å ÏïåÎ¶º
     - name: Deployment Summary
       run: |
        echo "============================================"
        echo "üéâ Deployment Completed Successfully!"
        echo "============================================"
        

 # ========================================
 # Î°§Î∞± Job (Î∞∞Ìè¨ Ïã§Ìå® Ïãú)
 # ========================================
 rollback:
   name: Rollback on Failure
   runs-on: ubuntu-latest
   needs: deploy
   if: failure()
  
   steps:
     - name: Configure SSH
       run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.HOST }} >> ~/.ssh/known_hosts


     - name: Rollback
       run: |
         ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.HOST }} << 'ENDSSH'
         echo "‚ö†Ô∏è Deployment failed! Attempting rollback..."
         cd /home/ubuntu/ya_prj
         
         # Ïù¥Ï†Ñ Ïª§Î∞ãÏúºÎ°ú Î°§Î∞±
         git reset --hard HEAD~1
         
         # Ïû¨Î∞∞Ìè¨
         cd app
         docker-compose down --remove-orphans || true
         docker-compose up -d --build
         
         echo "üîÑ Rollback completed!"
         ENDSSH
